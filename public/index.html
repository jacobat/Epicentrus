<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
	html { height: 100% }
	body { height: 100%; margin: 0px; padding: 0px }
	#map_canvas { height: 100% }
	#sliderContainer {
		position: fixed;
		bottom: 0;
		left: 0;
		width: 100%;
		height: 80px;
		background: grey;
	}
	#infoContainer {
		margin: 0 auto;
		width: 50%;
	}
	#slider {
		width: 70%;
		margin: 10px auto;
	}
</style>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/base/jquery-ui.css" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js"></script>
<script type="text/javascript">
	var intCol = [	'FFFF00',
					'FFFF00',
					'FFE200',
					'FFC600',
					'FFAA00',
					'FF8D00',
					'FF7100',
					'FF5500',
					'FF3800',
					'FF1C00',
					'FF0000',];

  function roundTime(time, resolution) {
    return new Date(Math.floor(time / resolution) * resolution);
  };

	$(function () {
    	var hour = 60*60*1000;
    	var day = 24 * hour;
		var resolution = hour; // 1 hour
		var minDate = roundTime(new Date().getTime() - (2 * day), resolution); // 2011-02-21T15:00:00+01:00
    	var maxDate = roundTime(new Date().getTime(), resolution); // 2011-02-25T17:00:00+01:00
		var max = Math.floor((maxDate.getTime() - minDate.getTime()) / resolution);
		currentHistoryId = max;
	    $('#slider').slider({
	        max: max,
			value: max,
	        slide: function(event, ui) {
	            var date = new Date(minDate.getTime()+(ui.value*resolution));
	            $('#displayDate').html($.datepicker.formatDate('mm/dd/yy', date)+' '+date.getHours()+':'+date.getMinutes());
				currentHistoryId = ui.value;
				updateMarkers();
	        }
	    });
	});
	
	var markers = [];
	var currentHistoryId;
	var currentThresholdDivider = 2;
	
	function updateMarkers() {
		for (var i in epicenters) {
			var ec = epicenters[i];
			if (epiHistory[ec.tag] != undefined) {
				var hist = epiHistory[ec.tag];
				if (markers[i] != undefined && hist[currentHistoryId] != undefined) {
					var reach = Math.floor(hist[currentHistoryId].reach/currentThresholdDivider);
					var impact = Math.floor(hist[currentHistoryId].impact/currentThresholdDivider);
					if (reach > 4)
						reach = 4;
					if (impact > 4)
						impact = 3;
					
					if (reach > 0 && impact > 0) {
						markers[i].setIcon(
							new google.maps.MarkerImage(
								'images/epicenter_icons.png',
								new google.maps.Size(52, 52), // Size of marker
							      new google.maps.Point(((reach-1)*52), ((impact-1)*52)), // Origin in sprite: (reach, impact)
							      new google.maps.Point(26, 26) // Anchor (where the center is) in relation to the origin
								)
							);
						markers[i].setVisible(true);
					} else {
						markers[i].setVisible(false);
					}
					
				}
			}
		}
	}
	
	function initMap() {
    	var latlng = new google.maps.LatLng(0, 0);
	    var myOptions = {
	      zoom: 2,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.ROADMAP
	    };
	    var map = new google.maps.Map(document.getElementById("map_canvas"),
	        myOptions);

		for(var i in epicenters) {
			var ec = epicenters[i];
			(function (i, ec) {
				markers[i] = new google.maps.Marker({
				      position: new google.maps.LatLng(ec.lat, ec.lng), 
				      map: map, 
				      title: ec.name,
				  });
				google.maps.event.addListener(markers[i], 'click', function() {
				    console.log(this);
					console.log(ec);
				});
				updateMarkers();
			})(i, ec);
		}
	}
	
	var epicenters = [
						{
							name: 'StartupWeekend Copenhagen',
							lat: 55.680476,
							lng: 12.524779,
							tag: '#swcph',
						},
						{
							name: 'StartupWeekend Austin',
							lat: 30.283381,
							lng: -97.743988,
							tag: '#swaustin',
						},
						{
							name: 'StartupWeekend Boulder',
							lat: 40.020253,
							lng: -105.268936,
							tag: '#swboulder',
						},
						{
							name: 'StartupWeekend Dublin',
							lat: 53.349937,
							lng: -6.265984,
							tag: '#swdub',
						},
						{
							name: 'StartupWeekend Houston',
							lat: 29.791792,
							lng: -95.386047,
							tag: '#HoustonSW',
						},
						{
							name: 'StartupWeekend San Diego',
							lat: 32.726642,
							lng: -117.154083,
							tag: '#swsd2',
						},
						{
							name: 'StartupWeekend Tunis',
							lat: 34.152727,
							lng: 9.700928,
							tag: '#swtunis',
						},
						{
							name: 'StartupWeekend Des Moine',
							lat: 41.606458,
							lng: -93.608665,
							tag: '#swdsm',
						},
						
					];
					
	var epiHistory = {};
	jQuery.getJSON('tweetstats', function(data) {
	  epiHistory = data;
	});
</script>
</head>
<body onload="initMap();">
 	<div id="map_canvas" style="width:100%; height:100%"></div> 
	<div id="sliderContainer">
		<div id="slider"></div>
		<div id="infoContainer">Date: <span id="displayDate"></span></div>
	</div>
</body>
</html>