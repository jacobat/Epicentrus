<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
<style type="text/css">
	html { 
		height: 100% 
	}
	body {
		height: 100%; 
		margin: 0px; 
		padding: 0px;

	}
	#map_canvas { height: 100% }
	#sliderContainer {
		color: #FFFFFF;
		text-shadow: #000000 1px 1px 1px;
		font-family: 'Droid Sans', arial, serif;
		
		position: fixed;
		bottom: 0;
		left: 0;
		width: 100%;
		height: 30px;
		
		background: #626060; /* old browsers */
		background: -moz-linear-gradient(top, #626060 0%, #484848 50%, #808080 100%); /* firefox */

		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#626060), color-stop(50%,#484848), color-stop(100%,#808080)); /* webkit */

		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#626060', endColorstr='#484848',GradientType=0 ); /* ie */
		
		-moz-box-shadow: 0 0 5px 2px #222;
		-webkit-box-shadow: 0 0 5px 2px #222;
		box-shadow: 0 0 5px 2px #222;
	}
	#sliderInfoContainer {
		display: block;
		width: 940px;
		margin: 0 auto;
	}
	#displayDate {
		display: block;
		float: left;
		width: 150px;
		text-align: right;
		margin-top: 5px;
	}
	#slider {
		float: left;
		font-size: 80%;
		width: 700px;
		margin: 10px auto;
	}
</style>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/themes/dark-hive/jquery-ui.css" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js"></script>
<script type="text/javascript">
	var intCol = [	'FFFF00',
					'FFFF00',
					'FFE200',
					'FFC600',
					'FFAA00',
					'FF8D00',
					'FF7100',
					'FF5500',
					'FF3800',
					'FF1C00',
					'FF0000',];
					
	function pad2(number) {
	     return (number < 10 ? '0' : '') + number
	}
	function roundTime(time, resolution) {
    	return new Date(Math.floor(time / resolution) * resolution);
  	};

	var hour = 60*60*1000;
	var day = 24 * hour;
	var resolution = hour; // 1 hour
	var minDate = roundTime(new Date().getTime() - (2 * day), resolution);
	var maxDate = roundTime(new Date().getTime(), resolution);
	
	$(function () {
		var max = Math.floor((maxDate.getTime() - minDate.getTime()) / resolution);
		currentHistoryId = max;
	    $('#slider').slider({
	        max: max,
			value: max,
	        slide: function(event, ui) {
				currentHistoryId = ui.value;
				updateMarkers();
	        }
	    });
	});
	
	var markers = [];
	var currentHistoryId;
	var currentThresholdDivider = 2;
	
	function updateMarkers() {
		var date = new Date(minDate.getTime()+(currentHistoryId*resolution));
        $('#displayDate').html($.datepicker.formatDate('mm/dd/yy', date)+' '+pad2(date.getHours())+':'+pad2(date.getMinutes()));

		for (var i in epicenters) {
			var ec = epicenters[i];
			if (epiHistory != null && epiHistory[ec.tag] != undefined) {
				var hist = epiHistory[ec.tag];
				if (markers[i] != undefined && hist[currentHistoryId] != undefined) {
					var reach = Math.floor(hist[currentHistoryId].reach/currentThresholdDivider);
					var impact = Math.floor(hist[currentHistoryId].impact/currentThresholdDivider);
					if (reach > 4)
						reach = 4;
					if (impact > 4)
						impact = 3;
					
					if (reach > 0 && impact > 0) {
						markers[i].setIcon(
							new google.maps.MarkerImage(
								'images/epicenter_icons.png',
								new google.maps.Size(52, 52), // Size of marker
							      new google.maps.Point(((reach-1)*52), ((impact-1)*52)), // Origin in sprite: (reach, impact)
							      new google.maps.Point(26, 26) // Anchor (where the center is) in relation to the origin
								)
							);
						markers[i].setVisible(true);
					} else {
						markers[i].setVisible(false);
					}
				}
			}
		}
	}
	
	function initMap() {
    	var latlng = new google.maps.LatLng(0, 0);
	    var myOptions = {
	      zoom: 2,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.SATELLITE
	    };
	    var map = new google.maps.Map(document.getElementById("map_canvas"),
	        myOptions);

		for(var i in epicenters) {
			var ec = epicenters[i];
			(function (i, ec) {
				markers[i] = new google.maps.Marker({
				      position: new google.maps.LatLng(ec.lat, ec.lng), 
				      map: map, 
				      title: ec.name,
				  });
				google.maps.event.addListener(markers[i], 'click', function() {
				    console.log(this);
					console.log(ec);
				});
				updateMarkers();
			})(i, ec);
		}
	}
	
	var epicenters = [
						{
							name: 'StartupWeekend Copenhagen',
							lat: 55.680476,
							lng: 12.524779,
							tag: '#swcph',
						},
						{
							name: 'StartupWeekend Austin',
							lat: 30.283381,
							lng: -97.743988,
							tag: '#swaustin',
						},
						{
							name: 'StartupWeekend Boulder',
							lat: 40.020253,
							lng: -105.268936,
							tag: '#swboulder',
						},
						{
							name: 'StartupWeekend Dublin',
							lat: 53.349937,
							lng: -6.265984,
							tag: '#swdub',
						},
						{
							name: 'StartupWeekend Houston',
							lat: 29.791792,
							lng: -95.386047,
							tag: '#HoustonSW',
						},
						{
							name: 'StartupWeekend San Diego',
							lat: 32.726642,
							lng: -117.154083,
							tag: '#swsd2',
						},
						{
							name: 'StartupWeekend Tunis',
							lat: 34.152727,
							lng: 9.700928,
							tag: '#swtunis',
						},
						{
							name: 'StartupWeekend Des Moine',
							lat: 41.606458,
							lng: -93.608665,
							tag: '#swdsm',
						},
						
					];
					
	var epiHistory = {};
	
	function calcHistoryDivider() {
			console.log(epiHistory);
		var maxReach = 0;
		var maxImpact = 0;
		$.each(epiHistory, function (i, el) {
			$.each(el, function (i, el) {
				if (el.reach > maxReach)
					maxReach = el.reach;
				if (el.impact > maxImpact)
					maxImpact = el.impact;
			});
		});
		currentThresholdDivider = Math.round(maxImpact/20);
	}

	jQuery.getJSON('tweetstats', function(data) {
		epiHistory = data;
		calcHistoryDivider();		
		updateMarkers();	
	});
</script>
</head>
<body onload="initMap();">
 	<div id="map_canvas" style="width:100%; height:100%"></div> 
	<div id="sliderContainer">
		<div id="sliderInfoContainer">
		<div id="slider"></div><span id="displayDate"></span>
		</div>
	</div>
</body>
</html>