<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
<link href="stylesheets/reset.css" rel="stylesheet" type="text/css" media="all" />
<link href="stylesheets/styles.css" rel="stylesheet" type="text/css" media="all" />
<style type="text/css">
	
</style>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/themes/dark-hive/jquery-ui.css" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js"></script>
<script type="text/javascript">
	var intCol = [	'FFFF00',
					'FFFF00',
					'FFE200',
					'FFC600',
					'FFAA00',
					'FF8D00',
					'FF7100',
					'FF5500',
					'FF3800',
					'FF1C00',
					'FF0000',];
					
	function pad2(number) {
	     return (number < 10 ? '0' : '') + number
	}
	function roundTime(time, resolution) {
    	return new Date(Math.floor(time / resolution) * resolution);
  	};

	var hour = 60*60*1000;
	var day = 24 * hour;
	var resolution = hour; // 1 hour
	var minDate = roundTime(new Date().getTime() - (2 * day), resolution);
	var maxDate = roundTime(new Date().getTime(), resolution);
	
	$(function () {
		var max = Math.floor((maxDate.getTime() - minDate.getTime()) / resolution);
		currentHistoryId = max;
	    $('#slider').slider({
	        max: max,
			value: max,
	        slide: function(event, ui) {
				currentHistoryId = ui.value;
				updateMarkers();
	        }
	    });
	
	
		$('#close-panel').click(function() {
			$('#panel').slideToggle("slow");
		});
		
		// open data tab
		$('#data-tab').click(function() {
			$('#media').hide();
			$('#media-tab').removeClass('selected');
			$('#data-tab').addClass('selected');
			$('#data').fadeIn("slow");
		});
		
		// open media tab
		$('#media-tab').click(function() {
			$('#data').hide();
			$('#data-tab').removeClass('selected');
			$('#media-tab').addClass('selected');
			$('#media').fadeIn("slow");
		});
		
		// example for second pane
		$('#twitter,#overlay,#close-detail-panel').click(function() {
			$('#detail-panel').slideToggle("slow");
			if($('#overlay').hasClass('on')) {
				$('#overlay').removeClass('on');
				$('#overlay').css({
					visibility:'hidden'
				});
				$('#overlay').animate({
					opacity: 0,
				}, 500, function() {
					// Animation complete.
				});
			} else {
				$('#overlay').addClass('on');
				$('#overlay').css({
					visibility:'visible'
				});
				$('#overlay').animate({
					opacity: 0.4,
				}, 500, function() {
					// Animation complete.
				});
			}
		});
	
	});
	
	var markers = [];
	var currentHistoryId;
	var currentThresholdDivider = 2;
	
	function updateMarkers() {
		var date = new Date(minDate.getTime()+(currentHistoryId*resolution));
        $('#displayDate').html($.datepicker.formatDate('mm/dd/yy', date)+' '+pad2(date.getHours())+':'+pad2(date.getMinutes()));

		for (var i in epicenters) {
			var ec = epicenters[i];
			if (epiHistory != null && epiHistory[ec.tag] != undefined) {
				var hist = epiHistory[ec.tag];
				if (markers[i] != undefined && hist[currentHistoryId] != undefined) {
					var reach = Math.floor(hist[currentHistoryId].reach/currentThresholdDivider);
					var impact = Math.floor(hist[currentHistoryId].impact/currentThresholdDivider);
					if (reach > 4)
						reach = 4;
					if (impact > 4)
						impact = 3;
					
					if (reach > 0 && impact > 0) {
						markers[i].setIcon(
							new google.maps.MarkerImage(
								'images/epicenter_icons.png',
								new google.maps.Size(52, 52), // Size of marker
							      new google.maps.Point(((reach-1)*52), ((impact-1)*52)), // Origin in sprite: (reach, impact)
							      new google.maps.Point(26, 26) // Anchor (where the center is) in relation to the origin
								)
							);
						markers[i].setVisible(true);
					} else {
						markers[i].setVisible(false);
					}
				}
			}
		}
	}
	
	function initMap() {

		
    	var latlng = new google.maps.LatLng(40, -20);
	    var myOptions = {
	      zoom: 3,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.SATELLITE,
			mapTypeControl: false,
		    panControl: true,
		    panControlOptions: {
		        position: google.maps.ControlPosition.LEFT_CENTER
		    },
		    zoomControl: true,
		    zoomControlOptions: {
		        position: google.maps.ControlPosition.LEFT_CENTER
		    },
		    scaleControl: false,
		    streetViewControl: false,
	    };
	    var map = new google.maps.Map(document.getElementById("map"),
	        myOptions);
	
		var groundOverlayBounds = new google.maps.LatLngBounds(
		    new google.maps.LatLng(-46.0,-178.9999),
		    new google.maps.LatLng(80.0,179.9999));
		var overlayMap = new google.maps.GroundOverlay(
			    "images/map_grounds_overlay.png",
			    groundOverlayBounds,
				{map: map});

		for(var i in epicenters) {
			var ec = epicenters[i];
			(function (i, ec) {
				markers[i] = new google.maps.Marker({
				      position: new google.maps.LatLng(ec.lat, ec.lng), 
				      map: map, 
				      title: ec.name,
				  });
				google.maps.event.addListener(markers[i], 'click', function() {
				    console.log(this);
					console.log(ec);
					$('#panel').slideToggle("slow");
				});
				updateMarkers();
			})(i, ec);
		}
	}
	
	var epicenters = [
						{
							name: 'StartupWeekend Copenhagen',
							lat: 55.680476,
							lng: 12.524779,
							tag: '#swcph',
						},
						{
							name: 'StartupWeekend Austin',
							lat: 30.283381,
							lng: -97.743988,
							tag: '#swaustin',
						},
						{
							name: 'StartupWeekend Boulder',
							lat: 40.020253,
							lng: -105.268936,
							tag: '#swboulder',
						},
						{
							name: 'StartupWeekend Dublin',
							lat: 53.349937,
							lng: -6.265984,
							tag: '#swdub',
						},
						{
							name: 'StartupWeekend Houston',
							lat: 29.791792,
							lng: -95.386047,
							tag: '#HoustonSW',
						},
						{
							name: 'StartupWeekend San Diego',
							lat: 32.726642,
							lng: -117.154083,
							tag: '#swsd2',
						},
						{
							name: 'StartupWeekend Tunis',
							lat: 34.152727,
							lng: 9.700928,
							tag: '#swtunis',
						},
						{
							name: 'StartupWeekend Des Moine',
							lat: 41.606458,
							lng: -93.608665,
							tag: '#swdsm',
						},
						
					];
					
	var epiHistory = {};
	
	function calcHistoryDivider() {
    //  console.log(epiHistory);
    // var maxReach = 0;
    // var maxImpact = 0;
    // $.each(epiHistory, function (i, el) {
    //  $.each(el, function (i, el) {
    //    if (el.reach > maxReach)
    //      maxReach = el.reach;
    //    if (el.impact > maxImpact)
    //      maxImpact = el.impact;
    //  });
    // });
    // currentThresholdDivider = Math.round(maxImpact/20);
    currentThresholdDivider = 3;
	}
	calcHistoryDivider();

	jQuery.getJSON('tweetstats', function(data) {
		epiHistory = data;
		updateMarkers();	
	});

</script>
</head>
<body onload="initMap();">
	<div id="top">
		<div id="topInner">
		<div id="login">
			<a href="#">Log in</a>
		</div>
		<div id="logo">
			Epicenterus
		</div>
		<div id="search">
			<label for="search-field"></label>
			<input id="search-field" type="text" />
		</div>
		</div>
	</div>
	
	
	<div id="map">
		<a id="panel-trigger" href="#">Epicenter</a>
	</div>
	<div id="overlay"></div>
	
	<div id="panel">
	
		<a id="close-panel" href="#">x</a>
		<ul id="tabs">
			<li><a id="data-tab" href="javascript:void(0);" class="selected">Data</a></li>
			<li><a id="media-tab" href="javascript:void(0);">Social Media</a></li>
		</ul>
		
		
		<div id="panel-content">
		
			<div id="data">
				<div class="modules-4">
					<div class="module-inner">
						
						<h3 class="count">31,234<br /><span>tweets</span></h3>
					</div>
				</div>
				<div class="modules-4">
					<div class="module-inner">
						<h3>Second</h3>
						<p>This is the data tab. This is the data tab. This is the data tab.</p>
					</div>
				</div>
				<div class="modules-4">
					<div class="module-inner">
						<h3>Third</h3>
						<p>This is the data tab. This is the data tab. This is the data tab.</p>
					</div>
				</div>
				<div class="modules-4">
					<div class="module-inner">
						<h3>Forth</h3>
						<p>This is the data tab. This is the data tab. This is the data tab.</p>
					</div>
				</div>
			</div>
			<div id="media">
				<div id="panel-1">
				<h3>Twitter</h3>
				<a href="#" id="twitter">more..</a>
				</div>
			</div>
		</div>
	</div>
	
	<div id="detail-panel">
		<div id="detail-panel-inner">
			<a id="close-detail-panel" href="#">x</a>
			<h2>Detail pane</h2>
			<p>The detail pane here</p>
		</div>
	</div>
	
	<div id="sliderContainer">
		<div id="sliderInfoContainer">
		<div id="slider"></div><span id="displayDate"></span>
		</div>
	</div>
</body>
</html>