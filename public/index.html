<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
<link href="stylesheets/reset.css" rel="stylesheet" type="text/css" media="all" />
<link href="stylesheets/styles.css" rel="stylesheet" type="text/css" media="all" />
<style type="text/css">
	
</style>
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/themes/dark-hive/jquery-ui.css" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js"></script>
<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js" type="text/javascript" charset="utf-8"></script>
<script src="javascripts/jquery.timeago.js" type="text/javascript" charset="utf-8"></script>
<script src="javascripts/application.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	var intCol = [	'FFFF00',
					'FFFF00',
					'FFE200',
					'FFC600',
					'FFAA00',
					'FF8D00',
					'FF7100',
					'FF5500',
					'FF3800',
					'FF1C00',
					'FF0000',];
					
	function pad2(number) {
	     return (number < 10 ? '0' : '') + number
	}
	function roundTime(time, resolution) {
    	return new Date(Math.floor(time / resolution) * resolution);
  	};

	var hour = 60*60*1000;
	var day = 24 * hour;
	var resolution = hour; // 1 hour
	var minDate = roundTime(new Date().getTime() - (2 * day), resolution);
	var maxDate = roundTime(new Date().getTime(), resolution);
	
	$(function () {
		var max = Math.floor((maxDate.getTime() - minDate.getTime()) / resolution);
		currentHistoryId = max;
	    $('#slider').slider({
	        max: max,
			value: max,
	        slide: function(event, ui) {
				currentHistoryId = ui.value;
				updateMarkers();
	        }
	    });
	
		$('#close-panel').click(function() {
			$('#panel').slideToggle("slow");
		});
		
		// open data tab
		$('#data-tab').click(function() {
			$('#media').hide();
			$('#media-tab').removeClass('selected');
			$('#data-tab').addClass('selected');
			$('#data').fadeIn("slow");
		});
		
		// open media tab
		$('#media-tab').click(function() {
			$('#data').hide();
			$('#data-tab').removeClass('selected');
			$('#media-tab').addClass('selected');
			$('#media').fadeIn("slow");
		});
		
		// example for second pane
		$('#twitter,#overlay,#close-detail-panel').click(function() {
			$('#detail-panel').slideToggle("slow");
			if($('#overlay').hasClass('on')) {
				$('#overlay').removeClass('on');
				$('#overlay').css({
					visibility:'hidden'
				});
				$('#overlay').animate({
					opacity: 0,
				}, 500, function() {
					// Animation complete.
				});
			} else {
				$('#overlay').addClass('on');
				$('#overlay').css({
					visibility:'visible'
				});
				$('#overlay').animate({
					opacity: 0.4,
				}, 500, function() {
					// Animation complete.
				});
			}
		});
	
	  function update_slides(slides, slideWidth) {
	    slides.css({
		    'float' : 'left',
		    'width' : slideWidth
		  })
	  }
	
		/* twitter slide shizzle */
		  var currentPosition = 0;
		  var slidesDisplayed = 3;
		  var slideWidth = 912;
		  var slides = $('#tweets .tweet');
		  var numberOfSlides = 10;
		  var numberOfPages = Math.ceil(numberOfSlides/slidesDisplayed);
		
		  var dots = '';
		  for (var i=0; i<numberOfPages; i++) {
			dots += '<li id="dot-'+i+'">&bull;</li>';
		  }
		  $('#dots ul').html(dots);
		  // Wrap all .slides with #slideInner div
		  slides.wrapAll('<div id="slideInner"></div>');

		  // Set #slideInner width equal to total width of all slides
		  $('#slideInner').css('width', slideWidth * numberOfSlides);

		  // Hide left arrow control on first load
		  manageControls(currentPosition);

		  // Create event listeners for .controls clicks
		  $('#rightControl,#leftControl').bind('click', function(){
		    // Determine new position
		      currentPosition = ($(this).attr('id')=='rightControl') ? currentPosition+1 : currentPosition-1;

		      // Hide / show controls
		      manageControls(currentPosition);
		      // Move slideInner using margin-left							
		      $('#slideInner').animate({
		        'marginLeft' : slideWidth*(-currentPosition)
		      });
		    });

		  // manageControls: Hides and shows controls depending on currentPosition
		  function manageControls(position){
			
			$('#dots ul li').removeClass('selected');
			$('#dot-'+position).addClass('selected');
			
		    // Hide left arrow if position is first slide
		    if (position==0){ 
				$('#leftControl').css({
					visibility:'hidden'
				});
			} else { 
				$('#leftControl').css({
					visibility:'visible'
				});
			}
		    // Hide right arrow if position is last slide
		    if (position==numberOfPages-1) { 
				$('#rightControl').css({
					visibility:'hidden'
				});
			} else { 
				$('#rightControl').css({
					visibility:'visible'
				});

			}
		  }

	});
	
	var markers = [];
	var currentHistoryId;
	var currentThresholdDivider = 2;

  function selectedTime() {
    return ((new Date($('#displayDate').text()).getTime()) / 1000);
  }

	function updateMarkers() {
		var date = new Date(minDate.getTime()+(currentHistoryId*resolution));
        $('#displayDate').html($.datepicker.formatDate('mm/dd/yy', date)+' '+pad2(date.getHours())+':'+pad2(date.getMinutes()));

		for (var i in epicenters) {
			var ec = epicenters[i];
			if (epiHistory != null && epiHistory[ec.tag] != undefined) {
				var hist = epiHistory[ec.tag];
				if (markers[i] != undefined && hist[currentHistoryId] != undefined) {
					var reach = Math.floor(hist[currentHistoryId].reach/currentThresholdDivider);
					var impact = Math.floor(hist[currentHistoryId].impact/currentThresholdDivider);
					if (reach > 4)
						reach = 4;
					if (impact > 4)
						impact = 3;
					
					if (reach > 0 && impact > 0) {
						markers[i].setIcon(
							new google.maps.MarkerImage(
								'images/epicenter_icons.png',
								new google.maps.Size(52, 52), // Size of marker
							      new google.maps.Point(((reach-1)*52), ((impact-1)*52)), // Origin in sprite: (reach, impact)
							      new google.maps.Point(26, 26) // Anchor (where the center is) in relation to the origin
								)
							);
						markers[i].setVisible(true);
					} else {
						markers[i].setVisible(false);
					}
				}
			}
		}
	}

  function update_tweets(tweets) {
    $.each(tweets, function(idx, tweet) {
      tweet.time_string = $.timeago(new Date(tweet.tweet.created_at));
    });
    $('#media #slideInner').text('');
    $.tmpl($('#tweet_template'), tweets).autolink().appendTo($('#media #slideInner'));
    $('.tweet').css({
      'float' : 'left',
      'width' : 290
    });
  }
	
	function initMap() {

		
    	var latlng = new google.maps.LatLng(40, -20);
	    var myOptions = {
	      zoom: 3,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.SATELLITE,
			mapTypeControl: false,
		    panControl: false,
		    zoomControl: false,
		    scaleControl: false,
		    streetViewControl: false,
	    };
	    var map = new google.maps.Map(document.getElementById("map"),
	        myOptions);
	
		var groundOverlayBounds = new google.maps.LatLngBounds(
		    new google.maps.LatLng(-46.0,-178.9999),
		    new google.maps.LatLng(80.0,179.9999));
		var overlayMap = new google.maps.GroundOverlay(
			    "images/map_grounds_overlay.png",
			    groundOverlayBounds,
				{map: map});

		for(var i in epicenters) {
			var ec = epicenters[i];
			(function (i, ec) {
				markers[i] = new google.maps.Marker({
				      position: new google.maps.LatLng(ec.lat, ec.lng), 
				      map: map, 
				      title: ec.name,
				  });
				google.maps.event.addListener(markers[i], 'click', function() {
					$('#panel').toggle();
					/*
					$('#panel').slideToggle("slow", function() {
						
					});
					*/
					$.getJSON('/tweets/' + escape(ec.tag) + '?before=' + selectedTime(), function(data) {
					  update_tweets(data);
					});
				});
				updateMarkers();
			})(i, ec);
		}
	}
	
	var epicenters = [
						{
							name: 'StartupWeekend Copenhagen',
							lat: 55.680476,
							lng: 12.524779,
							tag: '#swcph',
						},
						{
							name: 'StartupWeekend Austin',
							lat: 30.283381,
							lng: -97.743988,
							tag: '#swaustin',
						},
						{
							name: 'StartupWeekend Boulder',
							lat: 40.020253,
							lng: -105.268936,
							tag: '#swboulder',
						},
						{
							name: 'StartupWeekend Dublin',
							lat: 53.349937,
							lng: -6.265984,
							tag: '#swdub',
						},
						{
							name: 'StartupWeekend Houston',
							lat: 29.791792,
							lng: -95.386047,
							tag: '#HoustonSW',
						},
						{
							name: 'StartupWeekend San Diego',
							lat: 32.726642,
							lng: -117.154083,
							tag: '#swsd2',
						},
						{
							name: 'StartupWeekend Tunis',
							lat: 34.152727,
							lng: 9.700928,
							tag: '#swtunis',
						},
						
					];
					
	var epiHistory = {};
	
	function calcHistoryDivider() {
    //  console.log(epiHistory);
    // var maxReach = 0;
    // var maxImpact = 0;
    // $.each(epiHistory, function (i, el) {
    //  $.each(el, function (i, el) {
    //    if (el.reach > maxReach)
    //      maxReach = el.reach;
    //    if (el.impact > maxImpact)
    //      maxImpact = el.impact;
    //  });
    // });
    // currentThresholdDivider = Math.round(maxImpact/20);
    currentThresholdDivider = 3;
	}
	calcHistoryDivider();

	jQuery.getJSON('tweetstats', function(data) {
		epiHistory = data;
		updateMarkers();	
	});

</script>
</head>
<body onload="initMap();">
  <script id="tweet_template" type="text/x-jquery-tmpl" charset="utf-8">
    <div id="tweet-${tweet.twitter_id}" class="tweet{{if thumb}} image{{/if}}">
      {{if thumbnail}}<img src="${thumb}" width="100" height="140" />{{/if}}
      <div class="text">${tweet.data.text}</div>
      <div class="extra"><span class="time">${time_string}</span> from <span class="from"><a href="#">${tweet.data.from_user}</a></span></div>
    </div>
  </script>
	<div id="top" class="panelBg">
		<div id="topInner">
		<div id="login">
			<a href="#">Log in</a>
		</div>
		<div id="logo">
			Epicenterus
		</div>
		<div id="search">
			<label for="search-field"></label>
			<input id="search-field" type="text" />
		</div>
		</div>
	</div>
	
	
	<div id="map">
		<a id="panel-trigger" href="#">Epicenter</a>
	</div>
	<div id="overlay"></div>
	
	<div id="panel">
	
		<a id="close-panel" href="#">x</a>
		<ul id="tabs">
			<li><a id="data-tab" href="javascript:void(0);" class="selected panelBg">Data Feed</a></li>
			<li><a id="media-tab" href="javascript:void(0);"class="panelBg">Media Feed</a></li>
		</ul>
		
		
		<div id="panel-content" class="panelBg">
		
			<div id="data">
				<img src="images/static_stats.png" />
			</div>
			
			<div id="media">
				<div id="dots">
					<ul>
					</ul>
				</div>
				<div id="tweetsContainer">
					<div id="leftControl"></div>
					<div id="tweets">
				
						<div id="tweet-1" class="tweet image">
							<img src="http://farm6.static.flickr.com/5053/5479711533_ece2f0f143.jpg" width="100" height="140" />
							<div class="text">Foooo bar 1!! <a href="#">#swCPH</a></div>
							<div class="extra"><span class="time">45 minutes ago</span> from <span class="from"><a href="#">bssdk</a></span></div>
						</div>
						<div id="tweet-2" class="tweet">
							<div class="text">Foooo bar 2!! <a href="#">#swCPH</a></div>
							<div class="extra"><span class="time">45 minutes ago</span> from <span class="from"><a href="#">bssdk</a></span></div>
						</div>
						<div id="tweet-3" class="tweet image">
							<img src="http://farm6.static.flickr.com/5053/5479711533_ece2f0f143.jpg" width="100" height="140" />								
							<div class="text">Foooo bar 3!! <a href="#">#swCPH</a></div>
							<div class="extra"><span class="time">45 minutes ago</span> from <span class="from"><a href="#">bssdk</a></span></div>
						</div>
						<div id="tweet-4" class="tweet">
							<div class="text">Foooo bar 4!! <a href="#">#swCPH</a></div>
							<div class="extra"><span class="time">45 minutes ago</span> from <span class="from"><a href="#">bssdk</a></span></div>
						</div>
						<div id="tweet-5" class="tweet image">
							<img src="http://farm6.static.flickr.com/5053/5479711533_ece2f0f143.jpg" width="100" height="140" />						
							<div class="text">Foooo bar 5!! <a href="#">#swCPH</a></div>
							<div class="extra"><span class="time">45 minutes ago</span> from <span class="from"><a href="#">bssdk</a></span></div>
						</div>
						<div id="tweet-6" class="tweet">
							<div class="text">Foooo bar 6!! <a href="#">#swCPH</a></div>
							<div class="extra"><span class="time">45 minutes ago</span> from <span class="from"><a href="#">bssdk</a></span></div>
						</div>							
						<div id="tweet-7" class="tweet">
							<div class="text">Foooo bar 7!! <a href="#">#swCPH</a></div>
							<div class="extra"><span class="time">45 minutes ago</span> from <span class="from"><a href="#">bssdk</a></span></div>
						</div>									
					</div>
					<div id="rightControl"></div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="detail-panel">
		<div id="detail-panel-inner">
			<a id="close-detail-panel" href="#">x</a>
			<h2>Detail pane</h2>
			<p>The detail pane here</p>
		</div>
	</div>
	
	<div id="sliderContainer" class="panelBg">
		<div id="sliderInfoContainer">
		<div id="slider"></div><span id="displayDate"></span>
		</div>
	</div>
</body>
</html>